<!DOCTYPE html>

<head>
    <style>
        form>div {
            padding: 5px 0;
        }

        form label {
            display: inline-block;
            width: 5em;
            text-align: right;
            vertical-align: top;
            padding: 0px 10px 0px 0;
        }

        form input,
        form textarea {
            padding: 8px 10px;
            width: 25em;
            border: 1px solid #aaa;
        }

        form button {
            padding: 8px 10px;
            background: #fff;
            min-width: 8em;
            border: 1px solid #aaa;
        }
    </style>
</head>

<body>
    <h3>登陆:</h3>
    <form class="login">
        <div>
            <label>url:</label>
            <textarea name="url"></textarea>
        </div>
        <div>
            <label>method:</label>
            <input name="method" disabled value="POST" />
        </div>
        <div>
            <label>data:</label>
            <textarea name="data" rows=5>
{
    "username": "demouser",
    "password": "demoUser123,"
}</textarea>
        </div>
        <div>
            <label></label>
            <button type="submit">提交</button>
        </div>

        <div>
            <label>response status:</label>
            <input name="status" disabled value="" />
        </div>
        <div>
            <label>response:</label>
            <textarea name="response" rows=4 disabled></textarea>
        </div>
    </form>

    <h3>续约:</h3>
    <form class="renew">
        <div>
            <label>url:</label>
            <textarea name="url"></textarea>
        </div>
        <div>
            <label>method:</label>
            <input name="method" disabled value="PUT" />
        </div>
        <div>
            <label>data:</label>
            <textarea name="data" rows=3>
{
    "refresh_token": ""
}
            </textarea>
        </div>
        <div>
            <label></label>
            <button type="submit">提交</button>
        </div>

        <div>
            <label>response status:</label>
            <input name="status" disabled value="" />
        </div>
        <div>
            <label>response:</label>
            <textarea name="response" rows=5 disabled></textarea>
        </div>
    </form>

    <h3>注销:</h3>
    <form class="logout">
        <div>
            <label>url:</label>
            <textarea name="url"></textarea>
        </div>
        <div>
            <label>method:</label>
            <input name="method" disabled value="DELETE" />
        </div>
        <div>
            <label></label>
            <button type="submit">提交</button>
        </div>

        <div>
            <label>response status:</label>
            <input name="status" disabled value="" />
        </div>
        <div>
            <label>response:</label>
            <textarea name="response" rows=5 disabled></textarea>
        </div>
    </form>

    <script>
        let device = 'web'
        let urls = document.querySelectorAll('textarea[name=url]')
        urls[0].value = `${location.href}?provider=password&remember=1&device=${device}`
        urls[1].value = location.href
        urls[2].value = `${location.href}?device=${device}`

        forms = document.querySelectorAll('form')
        var login = forms[0]
        var renew = forms[1]
        var logout = forms[2]
        login.addEventListener("submit", function (e) {
            e.preventDefault()

            let url = this.querySelector('textarea[name=url]').value
            let method = this.querySelector('input[name=method]').value
            let data = JSON.parse(this.querySelector('textarea[name=data]').value)
            let status = this.querySelector('input[name=status]')
            let response = this.querySelector('textarea[name=response]')
            let refresh = renew.querySelector('textarea[name=data]')

            status.value = '...'
            response.value = '...'

            fetch(url, {
                method,
                credentials: "include",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data),
            })
                .then(r => {
                    console.log(r)
                    status.value = `${r.status}: ${r.statusText}`
                    return r
                })
                .then(r => r.text())
                .then(r => {
                    try {
                        r = JSON.parse(r)
                        response.value = JSON.stringify(r, null, 2)
                        return r
                    } catch (e) {
                        response.value = r
                        throw e
                    }
                })
                .then(r => {
                    refresh.value = `{\n  "refresh_token": "${r.refresh_token}"\n}`
                })

        }, false)

        renew.addEventListener("submit", function (e) {
            e.preventDefault()

            let url = this.querySelector('textarea[name=url]').value
            let method = this.querySelector('input[name=method]').value
            let data = JSON.parse(this.querySelector('textarea[name=data]').value)
            let status = this.querySelector('input[name=status]')
            let response = this.querySelector('textarea[name=response]')

            status.value = '...'
            response.value = '...'

            fetch(url, {
                method,
                credentials: "include",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data),
            })
                .then(r => {
                    console.log(r)
                    status.value = `${r.status}: ${r.statusText}`
                    return r
                })
                .then(r => r.text())
                .then(r => {
                    try {
                        r = JSON.parse(r)
                        response.value = JSON.stringify(r, null, 2)
                        return r
                    } catch (e) {
                        response.value = r
                        throw e
                    }
                })
        })

        logout.addEventListener("submit", function (e) {
            e.preventDefault()

            let url = this.querySelector('textarea[name=url]').value
            let method = this.querySelector('input[name=method]').value
            let status = this.querySelector('input[name=status]')
            let response = this.querySelector('textarea[name=response]')

            status.value = '...'
            response.value = '...'

            fetch(url, {
                method,
                credentials: "include",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            })
                .then(r => {
                    console.log(r)
                    status.value = `${r.status}: ${r.statusText}`
                    return r
                })
                .then(r => r.text())
                .then(r => {
                    try {
                        r = JSON.parse(r)
                        response.value = JSON.stringify(r, null, 2)
                        return r
                    } catch (e) {
                        response.value = r
                        throw e
                    }
                })
        })
    </script>

</body>

</html>